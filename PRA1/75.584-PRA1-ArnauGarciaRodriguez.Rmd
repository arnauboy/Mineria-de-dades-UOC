---
title: 'Mineria de dades: PRA1 - Selecció i preparació d''un joc de dades'
author: "Autor: Arnau Garcia Rodríguez"
date: "Novembre 2023"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
    includes:
      in_header: 05.584-PAC-header-1.html
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Context i objectius

Imaginem que formem part del ministeri d'educació d'un país i volem saber quines condicions afavoreixen que els nostres alumnes de secundària tinguin millors qualificacions. D'aquesta forma, podrem dur a terme mesures per afavorir aquestes condicions i resoldre  aquelles que són un impediment.

Obtindrem aquest coneixement i aplicarem models supervisats i no supervisats. 

D'una banda, aplicarem models no supervisats de regressió per ser capaços de predir la qualificació d'un estudiant depenent de les seves condicions. 

D'altra banda, mitjançant models no supervisats, classificarem les instàncies a partir de la similitud de les seves característiques. 

# Joc de dades

Utilitzarem un joc de dades anomenat **Student Performance**, que conté informació dels resultats obtinguts en la matèria de llengua portuguesa pels estudiants de dos instituts Portuguesos l'any 2008. Inclou característiques socials, demogràfiques, resultats i escolars. 

S'ha obtingut el joc de dades mitjanánt la plataforma UCI Machine Learning.

# Anàlisi exploratòria 

El primer pas és importar el conjunt de dades i visualitzar el nombre d'instàncies i quin tipus d'atributs tenim disponibles.

```{r}
path = 'student-por.csv'
studentsData <- read.csv(path, row.names=NULL)
```

```{r}
structure = str(studentsData)
```

Veiem com disposem de 649 observacions i 33 característiques diferents. A continuació, seleccionarem un subconjunt de les característiques que tenim disponibles i les descriurem:

```{r echo=TRUE, message=FALSE, warning=FALSE}
if(!require('dplyr')) install.packages('dplyr'); library('dplyr')
if(!require('Rmisc')) install.packages('Rmisc'); library('Rmisc')
if(!require('xfun')) install.packages('xfun'); library('xfun')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')

```

```{r}
n = c("school","sex","age","address","Pstatus","Medu","Fedu","traveltime","studytime","failures","schoolsup","famsup","paid","activities","higher", "romantic","famrel","freetime","goout","Dalc","Walc","absences","G1","G2","G3")
studentsData = studentsData %>% select(all_of(n))
structure = str(studentsData)
```

Aquesta reducció del nombre de dimensions permetrà millorar l'eficiència a l'hora de continuar fent el preprocessament i en una posterior construcció del model desitjat.

## Descripció dels atributs
* **school** 
  + GP: Gabriel Pereira
  + MS: Mousinho de Silveira
* **sex**: gènere
  + F: noia
  + M: noi
* **age**: edat
* **address**: tipus d'adreça
  + U: urbana
  + R: rural
* **Pstatus**: pares convivents
  + T: viuen junts
  + A: separats
* **Medu**: educació mare
  + 0: cap
  + 1: primària fins a 4t grau
  + 2: primària de 5è a 9è grau
  + 3: secundària
  + 4: educació superior
* **Fedu**: educació pare  
  + 0: cap
  + 1: primària fins a 4t grau
  + 2: primària de 5è a 9è grau
  + 3: secundària
  + 4: educació superior
* **traveltime**: temps de vitge fins l'escola
  + 1: < 15 minuts
  + 2: 15 a 20 minuts
  + 3: 30 min a 1 hora
  + 4: > 1 hora
* **studytime**: temps d'estudi setmanal
  + 1: < 2 hores
  + 2: 2-5 hores
  + 3: 5-10 hores
  + 4: > 10 hores
* **failures**: nombre de suspesos en classes anteriors
* **schoolsup**: suport educacional escolar extra. Binària
* **famsup**: suport educacional familiar. Binària
* **paid**: classes pagades de portugués. Binària
* **activities**: activitats extracurriculars. Binària
* **higher**: intenció de cursas estudis superiors. Binària
* **romantic**: relació romàntica. Binària
* **famrel**: qualitat de la relació amb la familia (1 (molt poc)-5(molt))
* **freetime**: temps lliure (1 (molt poc)-5(molt))
* **goout**: sortir amb amics (1 (molt poc)-5(molt))
* **Dalc**: consum d'alcohol els dies laborables (1 (molt poc)-5(molt))
* **Walc**: consum d'alcohol el cap de setmana (1 (molt poc)-5(molt))
* **absences**: nombre d'absències 

Nota de l'assignatura:

* **G1**: nota del primer quadrimestre (0-20)
* **G2**: nota del segon quadrimestre (0-20)
* **G3**: nota final (0-20)

Em sembla important donar context de com es tradueix una nota en l'escala de puntuacions portuguesa al format internacional.
* A: Excel·lent (20-18)
* B: Molt bé (17-16)
* C: Bé (15-14)
* D: Satisfactori (13-12)
* E: Suficient (11-10)
* F: Suspès (10-0)

En aquest apartat, descriurem i visualitzarem informació que ens ajudarà a entendre les dades i començar a adquirir coneixement. 

## Visualització de les característiques

Visualitzem un resum de les característiques numèriques de les nostres dades:

```{r}
summary(studentsData)
```

Algunes dades interessants son:

* L'edat dels alumnes va dels 15 als 22 anys.
* El nivell educatiu de les mares es lleugerament més alt que la dels pares
* La mitjana de temps d'estudi és 1,9 (a prop de 2, que vol dir entre 2-5 hores)
* El consum d'alcohol augmenta el cap de setmana
* En general senten que tenen bastant temps lliure i bona relació amb la seva familia
* La mitjana d'abscències són 3,659

//TODO incloure correlacions, histogrames...

## Histogrames

Aprofundirem en les dades a través d'histogrames d'algunes de les variables que poden resultar d'interés.


```{r echo=TRUE, message=FALSE, warning=FALSE}
histList<- list()

n = c("school","sex","address","Pstatus")
studentsDataAux= studentsData %>% select(all_of(n))
for(i in 1:ncol(studentsDataAux)){
  col <- names(studentsDataAux)[i]
  ggp <- ggplot(studentsDataAux, aes_string(x = col)) +
    geom_histogram(stat = "count",bins = 30, fill = "cornflowerblue", color = "black",ggtittle = "Comptador") 
      histList[[i]] <- ggp
}
 multiplot(plotlist = histList, cols = 1)
```

**Observacions**:

- Hi ha més alumnes de l'escola GP que MS
- Hi ha mes noies que nois
- La gran majoria d'alumnes viuen en entorns urbans
- La gran majoria de pares viuen junts



```{r echo=TRUE, message=FALSE, warning=FALSE}
histList<- list()

n = c("famrel","freetime","goout","Dalc","Walc")
studentsDataAux= studentsData %>% select(all_of(n))
for(i in 1:ncol(studentsDataAux)){
  col <- names(studentsDataAux)[i]
  ggp <- ggplot(studentsDataAux, aes_string(x = col)) +
    geom_histogram(stat = "count",bins = 30, fill = "green", color = "black",ggtittle = "Comptador") 
      histList[[i]] <- ggp
}
 multiplot(plotlist = histList, cols = 1)
```

**Observacions**:

- Bona relació familiar en general 
- Consum d'alcohol augmenta considerablement el cap de setmana

```{r echo=TRUE, message=FALSE, warning=FALSE}
histList<- list()

n = c("G1","G2", "G3")
studentsDataAux= studentsData %>% select(all_of(n))
for(i in 1:ncol(studentsDataAux)){
  col <- names(studentsDataAux)[i]
  ggp <- ggplot(studentsDataAux, aes_string(x = col)) +
    geom_histogram(bins = 30, fill = "purple", color = "black",ggtittle = "Comptador") 
      histList[[i]] <- ggp
}
 multiplot(plotlist = histList, cols = 1)
```

**Observacions**:

- Hi ha més 0s al G3
- El gràfic es molt semblant en les tres variables

## Correlació entre variables

A continuació mostrem la correlació entre les variables numèriques del joc de dades.

```{r echo=TRUE, message=FALSE, warning=FALSE}
if(!require("corrplot")) install.packages("corrplot"); library("corrplot")

n = c("age","Medu","Fedu","traveltime","studytime","failures","famrel","freetime","goout","Dalc","Walc","absences","G1","G2","G3")
factors= studentsData %>% select(all_of(n))
res<-cor(factors) 
corrplot(res,method="color",tl.col="black", tl.srt=30, order = "AOE", 
   number.cex=0.75,sig.level = 0.01, addCoef.col = "black")
```

**Observem un alt grau de correlació entre:**

- age - failures
- Walc - Dalc
- freetime - goout
- goout - Walc 
- Medu - Fedu
- G1 - G2 - G3
- G1, G2 i G3 correlació negativa amb failures

# Neteja 

En aquest apartat processarem les dades per eliminar les que siguin errònies i redundants

El primer pas serà veure si tenim valors nuls al nostre joc de dades

```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(is.na(studentsData))
```

Com podem veure, no tenim cap valor nul a cap de les columnes seleccionades. A continuació, fem la mateixa comprovació amb els valors buits

```{r echo=TRUE, message=FALSE, warning=FALSE}
colSums(studentsData=="")
```

Tampoc hi ha cap valor buit a cap de les columnes.

Executem una funció per identificar tuples duplicades

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
studentsData[duplicated(studentsData)]
```

Tampoc tenim cap tupla duplicada.

El joc de dades s'ha publicat sense valors nuls, absents o instàncies repetides. Això pot resultar de gran ajuda per tots aquells que el vulguin utilitzar per a dur a terme mineria de dades, com és el nostre cas.  
  
# Discretització 

En aquest apartat transformarem les dades per a que es pugui divir el valor d'un atribut numèric en 2 o més valors diferents. Al joc de dades tenim moltes variables categòriques, pero l'enunciat requereix d'un exemple de procés de discretització. Més concretament, discretitzarem la variable numèrica **absences**. 

Ho farem mitjançant el mètode *discretize* de la llibreria *arules*.

```{r}
summary(studentsData[,"absences"])
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(arules)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
studentsData['absencesIntervals'] <- discretize(studentsData$absences, method="interval", categories = 4, labels = NULL, ordered=FALSE, onlycuts=FALSE)
```

Hem dividit el nombre continu d'absències en 4 grups d'intervals. També hem decidit deixar-ho en intervals i no assignar un nom, ja que m'ha semblat més representatiu. Observe'm-ho mitjançant un gràfic.

```{r}
plot(studentsData$absencesIntervals, xlab="Abscències", ylab="Nombre d'instàncies", col = "ivory")
```

Veiem com la gran majoria dels estudiants formen part del primer interval. Per curiositat, comptem quans formen part de l'últim interval.

```{r echo=TRUE, message=FALSE, warning=FALSE}
table(studentsData$absencesIntervals)
```

Veiem com només hi ha cuatre estudiants que hagin faltat de 24 a 32 vegades.

# Reducció de dimensions (PCA)

L'anàlisi de components principals (PCA) és una tècnica que ens permetrà treballar amb noves característiques anomenades components, independents entre si.  A la pràctica, el que farem serà afegir al joc de dades original aquests nous components principals que recullin una variabilitat més alta.

Aquests nous components podran substituir altres variables menys importants i que no aportin gaire valor a la predicció de la qualificaió dels estudiants.

A continuació, escalarem les dades numèricques i hi aplicarem l'anàlisi de components principals:

```{r}
n = c("age","Medu","Fedu","traveltime","studytime","failures","famrel","freetime","goout","Dalc","Walc","absences","G1","G2","G3")
studentsDataNumeric = studentsData %>% select(all_of(n))
stu_scale <- scale(studentsDataNumeric)
pca.stu <- prcomp(stu_scale)
summary(pca.stu)
```

L'histograma següent mostra de forma visual el pes de cada dimensió sobre el total de dades.

```{r echo=TRUE, message=FALSE, warning=FALSE}
if (!require('factoextra')) install.packages('factoextra'); library('factoextra')
#Els valors propis corresponen a la quantitat de variació explicada per cada component principal (PC).
ev= get_eig(pca.stu)
ev
fviz_eig(pca.stu)
```

Farem servir el mètode de Kaiser per escollir les característiques. Aquest mètode es quedarà amb totes les dimensions amb variància superior a 1. 

```{r}
var_stu_scale <- pca.stu$sdev^2
head(var_stu_scale)
```

Veient aquestes variàncies, apliquem el mètode Kàiser i ens quedem amb els components 1, 2, 4 i 5. 

```{r}
pca_var <- get_pca_var(pca.stu)
pca_var
```

## Contribució

```{r}
pca_var <- get_pca_var(pca.stu)
pca_var
```

A continuació, observem la contribució de cadascuna de les variables originals numèriques als components principals. Aquelles que no contribueixin a la variablitat de les primeres 5 dimensions es podran eliminar per simplificar l'anàlisi i **reduir la dimensionalitat**.

```{r}
library(corrplot)
head(pca_var$contrib[,1:5],15)
```

```{r}
corrplot(pca_var$contrib[,1:5], is.corr=FALSE)
``` 

```{r}
fviz_pca_var(pca.stu, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")
             )
``` 

Veiem com les variables **studytime**, **traveltime** i **absences** no contribueixen gaire als components pricipals resultants del mètode PCA. Per tant, podem eliminar-los i afegir les dimensions principals al joc de dades.

```{r}
componentes_principales <- pca.stu$x[, 1:5]
variables_no_contributives <- c("studytime", "traveltime", "absences")

studentsData <- studentsData[, !(names(studentsData) %in% variables_no_contributives)]

datos_con_pca <- cbind(studentsData, componentes_principales)
structure = str(datos_con_pca)

```

# Conclusions

En aquesta primera part del projecte de mineria de dades, hem presentat l'objectiu analític i el joc de dades seleccionat. Hem dut a terme una exploració inicialde les dades, on hem descrit cadascún dels atributs, hem visualitzat hisogrames i la correlació de les variables entre elles. A l'apartat de neteja hem busca valors nuls o absents, però no n'hem trobat cap. Això indica que l'autor de les dades ha tingut cura de preparar-les adequadament abans de la seva publicació, assegurant-ne la qualitat.

Hem realitzat una discretització de la variable numèrica absences en intervals i, finalment, hem aplicat la tècnica d'anàlisi de components principals (PCA) per identificar els components més rellevants. Hem seleccionat els cinc primers components mitjançant el mètode Kaiser i els hem utilitzat per substituir les variables originals que no contribuïen significativament a la variabilitat d'aquests components.

# Bibliografia 

1. Cortez,Paulo. (2014). *Student Performance*. UCI Machine Learning Repository. https://doi.org/10.24432/C5TG7T.
https://archive.ics.uci.edu/

2. Abouelela. (2018). *Identify and Remove Duplicate Data in R - Datanovia.* Datanovia. https://www.datanovia.com/en/lessons/identify-and-remove-duplicate-data-in-r/

3. Study in europe. (n.d.). *The Portuguese grading system.* https://www.studyineurope.eu/study-in-portugal/grades

4. *discretize function - RDocumentation.* (n.d.). https://www.rdocumentation.org/packages/arules/versions/1.5-0/topics/discretize

5. Zach. (2021). *How to count number of occurrences in columns in R.* Statology. https://www.statology.org/r-count-number-of-occurrences-in-column/